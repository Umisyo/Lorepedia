# CLAUDE.md - Lorepedia 開発ガイドライン

このファイルはClaude Codeがプロジェクトで作業する際のガイドラインを定義します。

---

## プロジェクト概要

シェアード・ワールド創作支援Webアプリケーション

### 技術スタック

- **フレームワーク**: Next.js 15 (App Router)
- **言語**: TypeScript (strict mode)
- **スタイリング**: Tailwind CSS + shadcn/ui
- **データベース**: Supabase (PostgreSQL + pgvector)
- **AI**: Claude API (生成) + OpenAI API (Embedding)
- **状態管理**: React Hook Form + Zod
- **ビジュアライゼーション**: React Flow
- **テスト**: Vitest + React Testing Library + MSW

### 情報ソース

**原則: プロジェクト情報はNotionを参照する**

| 情報種別 | 参照先 |
|---------|--------|
| 技術仕様・アーキテクチャ | Notion |
| 機能要件・ユースケース | Notion |
| DB設計・テーブル構造 | Notion |
| 画面設計・UI仕様 | Notion |
| タスク管理 | Notion |

実装時に仕様や要件が不明な場合は、`lorepedia-notion` スキルを使用してNotionから情報を取得すること。

**仕様が見つからない場合のルール:**

1. Notionを検索しても該当する仕様が存在しない場合、その場で判断して実装を進める
2. **判断した内容は必ずNotionの関連ページに追記する**
3. 追記時は以下を明記する：
   - 判断日時
   - 判断内容
   - 判断理由

---

## コーディング規約

### 言語

- コミットメッセージ: **日本語**
- コードコメント: **日本語**
- 変数名・関数名: **英語** (キャメルケース/パスカルケース)

### TypeScript

#### 必須ルール

- `any`禁止 → `unknown` + 型ガード関数を使用
- 型アサーション（`as`）禁止 → 型ガード関数を使用

#### 型定義の配置

| 種類 | 配置場所 |
|------|----------|
| Supabase生成型 | `src/types/database.ts` |
| 共通型定義 | `src/types/` 配下に用途別ファイル |
| コンポーネント専用型 | 同一ファイル内 |
| Zodスキーマ | `src/schemas/` |

### ファイル命名規則

```
src/
├── components/
│   ├── ui/              # shadcn/uiコンポーネント (小文字)
│   │   └── button.tsx
│   └── features/        # 機能コンポーネント (パスカルケース)
│       └── WorldEditor.tsx
├── app/
│   └── (routes)/        # ルートグループ (小文字・ケバブケース)
│       └── world/
│           └── [id]/
│               └── page.tsx
└── lib/
    └── utils/           # ユーティリティ (キャメルケース)
        └── formatDate.ts
```

### コンポーネント設計

- 関数コンポーネント + 明示的なPropsの型定義
- named export優先（`export default`は避ける）

---

## 品質基準

### 型安全性

- [ ] `strict: true` を維持
- [ ] `any` 型の使用禁止（`unknown` + 型ガードを使用）
- [ ] 外部APIレスポンスは Zod でバリデーション
- [ ] Supabase型は自動生成を使用 (`pnpm supabase:types`)

### テスト

- [ ] 新規コンポーネント: 最低1つのテストケース
- [ ] ユーティリティ関数: 境界値を含むテスト
- [ ] API Route: MSWでモックしたテスト
- ファイル命名: `ComponentName.test.tsx`, `utilName.test.ts`

### パフォーマンス

- [ ] 画像: next/image を使用
- [ ] 動的インポート: 重いコンポーネントは `dynamic()` でコード分割
- [ ] メモ化: 高コストな計算には `useMemo` / `useCallback`
- [ ] リスト: 大量データは仮想化を検討

### コード一貫性

- [ ] ESLint エラー: 0件
- [ ] import順序: 外部 → 内部 → 相対パス
- [ ] 未使用変数・importの削除

---

## Git ワークフロー

### ブランチ命名

```
feature/機能名     # 新機能
fix/バグ内容       # バグ修正
refactor/対象     # リファクタリング
docs/対象         # ドキュメント
```

### コミットメッセージ

形式: `<種類>: <変更内容の要約>`

種類: `feat`(新機能), `fix`(バグ修正), `refactor`, `test`, `docs`, `chore`

---

## 開発ワークフロー

### ブランチとWorktree管理

| ルール | 説明 |
|--------|------|
| ブランチ作成 | 新規の変更作業を開始する際は、必ず専用ブランチを作成する |
| Worktree使用 | ブランチ作成後は `git worktree` を使用して作業ディレクトリを分離する |
| Worktree削除 | 作業が完全に完了し、マージ後はworktreeを削除する |
| ブランチ-タスク紐付け | 1ブランチ = 1タスクの原則を守る |

### 実装フロー（必須手順）

```
Worktree作成 → 実装 → (UI時: /frontend-verify + /rams) → Commit → Push → PR作成 → セルフレビュー
```

| Step | 操作 | スキル/コマンド |
|------|------|----------------|
| 1 | Worktree作成 | `/worktree-create` |
| 2 | 実装（1機能1コミット） | - |
| 2.5 | UI実装時レビュー | `/frontend-verify`, `/rams` |
| 3-5 | Commit → Push → PR | `/pr-create` |
| 6 | セルフレビュー（最大3回） | `pr-self-review` エージェント |

**Worktree操作**: `/worktree-create`, `/clean_gone` を使用

### 実装完了の定義

以下がすべて完了するまで、タスクは「完了」としない：

> **Note:** Lint・テストはhuskyのpre-commit/pre-pushフックで自動実行されます。
> コミットまたはプッシュ時にエラーが発生した場合は、修正してから再実行してください。

- [ ] 実装が完了している
- [ ] UI実装の場合: `/frontend-verify` で動作確認、`/rams` でデザイン・アクセシビリティレビューを実行し、指摘を解消済み
- [ ] Lintエラーがない
- [ ] テストが通る
- [ ] コミットされている
- [ ] リモートにPushされている
- [ ] PRが作成されている（または直接マージの場合はマージ完了）
- [ ] セルフレビューで🔴必須・🟡推奨の指摘がないこと（または3回修正済み）

### タスク管理

`task-manager` エージェントを使用してNotionタスク管理DBと連携する。

**ステータス遷移**: 未着手 → 進行中 → レビュー待ち → 完了（または保留）

**運用ルール**:
- タスク着手時 → 「進行中」、PR作成時 → 「レビュー待ち」、完了時 → 「完了」
- 派生タスク発見時は新規タスクとして登録（現タスクでは対応しない）

※ プロパティ定義・作成例は `task-manager` エージェント参照

---

## 開発コマンド

```bash
pnpm dev          # 開発サーバー起動
pnpm build        # 本番ビルド
pnpm lint         # ESLintチェック
pnpm test         # テスト実行（watchモード）
pnpm test:run     # テスト実行（単発）
pnpm storybook    # Storybook起動
pnpm supabase:types  # Supabase型生成
```

---

## 自動学習（フィードバックからのルール化）

ユーザーからの修正指示を受けたとき、それが汎用的なルールであれば自動的に記録し、次回から言われなくても従う。

### トリガー条件

以下のようなフィードバックを受けた場合、汎用的なルールとして自動記録する：

- 「今後は〜して」「いつも〜して」などの継続的指示
- 行動パターンや作業スタイルへの修正
- コーディング規約に関する指摘
- 「〜しないで」「〜は避けて」などの禁止事項

### 汎用性の判断基準

**汎用的（記録する）:**
- 特定のタスクではなく、行動パターンへの修正
- このプロジェクト（または横断的に）繰り返し適用される内容

**個別対応（記録しない）:**
- 「この場合は〜して」のような特定状況への指示
- 1回限りの例外的な対応

### 記録先の判断

| フィードバック種別 | 保存先 | 基準 |
|-------------------|--------|------|
| コーディング規約・スタイル | CLAUDE.md | このプロジェクト固有のルール |
| 繰り返し手順・ワークフロー | Skill作成 | 3ステップ以上の定型作業 |
| 技術知見・ベストプラクティス | Exocortex | プロジェクト横断で有用 |

### 記録フロー

1. フィードバック受信時に汎用性を判断
2. 汎用的な場合、適切な保存先を選択
3. 自動で記録を実行
4. 「📝 ルールとして記録しました: [概要]」と報告

### CLAUDE.md更新時の追記位置

- コーディング規約関連 → 「コーディング規約」セクション
- 開発フロー関連 → 「開発ワークフロー」セクション
- 品質関連 → 「品質基準」セクション
- 新規カテゴリ → 「拡張セクション」内に新設

---

## 拡張セクション

<!--
以下のセクションは必要に応じて追加してください:

### プロンプト管理
AI生成機能のプロンプトテンプレート管理ルール

### セキュリティ
認証・認可、入力バリデーションのルール

### アクセシビリティ
WAI-ARIA対応、キーボードナビゲーション

### 国際化 (i18n)
多言語対応の実装ガイドライン

### デプロイ
本番環境へのデプロイ手順
-->

---

## 参照リンク

- [Next.js App Router](https://nextjs.org/docs/app)
- [shadcn/ui](https://ui.shadcn.com/)
- [Supabase Docs](https://supabase.com/docs)
- [React Flow](https://reactflow.dev/)
