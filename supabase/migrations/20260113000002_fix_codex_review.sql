-- =============================================================================
-- Fix: Codex Review Issues
-- =============================================================================
-- P1: projectsのINSERTポリシーでowner_idの検証を追加
-- P2: pgvector拡張を明示的に作成
-- =============================================================================

-- -----------------------------------------------------------------------------
-- P2: pgvector拡張の明示的な有効化
-- -----------------------------------------------------------------------------
-- Supabaseでは通常extensionsスキーマに拡張がインストールされる
-- 新規プロジェクトでのマイグレーション実行を考慮して明示的に作成
CREATE EXTENSION IF NOT EXISTS vector WITH SCHEMA extensions;

-- -----------------------------------------------------------------------------
-- P1: projectsのINSERTポリシーを修正
-- -----------------------------------------------------------------------------
-- 既存のポリシーを削除
DROP POLICY IF EXISTS "projects: 認証済みユーザーのみ作成可能" ON projects;

-- 新しいポリシーを作成: owner_idが認証ユーザー自身であることを確認
-- これにより、他人のowner_idを設定してプロジェクトを作成することを防止
CREATE POLICY "projects: 認証済みユーザーが自身をownerとして作成可能" ON projects
  FOR INSERT WITH CHECK (auth.uid() IS NOT NULL AND auth.uid() = owner_id);
